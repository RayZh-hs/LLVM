package space.norb.llvm.transformation

import space.norb.llvm.analysis.AnalysisManager
import space.norb.llvm.structure.Module

/**
 * An IRPass encapsulates a transformation to the IR tree. It is the base for every optimization process.
 *
 * IR Passes rely on metadata to store information about the IR tree.
 * If the metadata is not present, the metadata will be generated by the pass itself.
 *
 * If the pass corrupts the metadata, the pass is either required to fix the metadata or to set it to null, in which
 * case the next pass will generate the metadata again.
 * */
abstract class IRPass {
    /**
     * Enact the transformation pass on the module. Does not ensure that the analysis manager is intact afterward.
     *
     * @param module The IR to transform
     * @param am The analysis manager, which may be used to query or update analyses.
     * @return The potentially modified module
     */
    abstract fun run(module: Module, am: AnalysisManager): Module

    /**
     * Update the analysis manager. Defaults to invalidating all results. Override to change behavior.
     *
     * @return The updated analysis module
     */
    open fun updateAnalysisManager(am: AnalysisManager) = am.apply { invalidateAll() }
}

/**
 * Simple wrapper for readonly IR passes.
 */
abstract class ReadonlyIRPass : IRPass() {
    final override fun updateAnalysisManager(am: AnalysisManager) = am.apply { invalidateNone() }
}